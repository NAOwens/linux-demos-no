---
- name: Perform Leapp upgrade on rhel host
  hosts: "{{ survey_hostname }}"

  vars_files:
    - vars/rhel{{ ansible_distribution_major_version }}_leapp_vars.yml

  tasks:
    - name: Register the host with the proper LEAPP Activation Key
      ansible.builtin.command: "subscription-manager register --org={{ sat_org }} --activationkey={{ leapp_ak }} --force"

    - name: Ensure Leapp is installed
      ansible.builtin.yum:
        name: leapp
        state: present

    - name: Include Leapp{{ ansible_distribution_major_version }} Inhibitor
      ansible.builtin.include_tasks: "tasks/leapp{{ ansible_distribution_major_version  }}_inhibitor_task.yml"

    - name: Run the leapp preupgrade
      ansible.builtin.command: leapp preupgrade
      changed_when: false
      register: preupgrade_result

    - name: Run the leapp upgrade
      ansible.builtin.command: leapp upgrade
      register: upgrade_result

    - name: Reboot the server to complete the upgrade
      ansible.builtin.reboot: